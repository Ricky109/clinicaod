import{_ as h,u as w,r as f,l as F,c as l,a as s,w as A,v as I,t as i,b,h as k,F as x,A as L,o as r,s as g,p as P}from"./index-Bp0xLay2.js";import{h as m}from"./pagoService-DPhzBUMq.js";const H={class:"card"},U={class:"filtros-container"},M={class:"filtros-row"},R={class:"filtro-item"},B={class:"filtro-item"},V={class:"filtro-buttons"},$=["disabled"],G=["disabled"],X={key:0,class:"cargando"},Y={key:1,class:"error-message"},j={key:2,class:"historial-container"},z={key:0,class:"no-pacientes"},q={class:"historial-row"},J={class:"historial-row"},K={class:"historial-row"},Q={class:"historial-row"},W={class:"historial-row"},Z={class:"estado-container"},tt={class:"estado-texto"},st=["onClick"],et={key:0},ot={key:1},at={class:"historial-row"},nt={__name:"Historial",setup(lt){const E=w(),c=f([]),v=f(!1),n=f(""),D=f({}),d=f(""),p=f("");F(async()=>{const t=new Date().toISOString().split("T")[0];d.value=t,p.value=t,await y()});async function y(){var o,t;try{v.value=!0,n.value="";const a=(o=E.user)==null?void 0:o.CDNIEST;if(!a){n.value="No se encontró el DNI del estudiante";return}console.log("Usuario autenticado completo:",E.user),console.log("CDNIEST (DNI del estudiante):",(t=E.user)==null?void 0:t.CDNIEST),console.log("DNI del estudiante para historial:",a);const e=d.value,u=p.value||d.value;if(e&&u&&new Date(e)>new Date(u)){n.value="La fecha de inicio no puede ser posterior a la fecha final.";return}const _=await m(a,e,u);c.value=_,console.log("Pacientes atendidos encontrados:",c.value)}catch(a){n.value="FALLÓ LA CONEXIÓN",console.error("Error:",a)}finally{v.value=!1}}async function S(){var o;try{v.value=!0,n.value="";const t=(o=E.user)==null?void 0:o.CDNIEST;if(!t){n.value="No se encontró el DNI del estudiante";return}const a=d.value,e=p.value||d.value;if(a&&e&&new Date(a)>new Date(e)){n.value="LA FECHA DE INICIO NO PUEDE SER POSTERIOR A LA FECHA FINAL.";return}const u=await m(t,a,e);c.value=u,console.log("Total de pacientes encontrados:",c.value.length)}catch(t){n.value=t.message||"Error al cargar el historial de pacientes",console.error("Error:",t)}finally{v.value=!1}}async function C(){d.value="",p.value="",c.value=[]}function N(o){switch(o){case"C":return{icon:"✔️",class:"estado-pagado",texto:"PAGADO"};case"A":return{icon:"⏳",class:"estado-pendiente",texto:"PENDIENTE DE PAGO"};case"X":return{icon:"❌",class:"estado-anulado",texto:"ANULADO"};case"F":return{icon:"📄",class:"estado-facturado",texto:"FACTURADO"};default:return{icon:"❔",class:"estado-desconocido",texto:"DESCONOCIDO"}}}async function O(o){try{D.value={...D.value,[o.codigo]:!0},n.value="";const t=`https://transacciones.ucsm.edu.pe//FILES/TMP/${o.cboleta}`;window.open(t,"_blank")}catch(t){console.error("Error al abrir boleta:",t),n.value="No se pudo abrir la boleta. Intenta nuevamente."}finally{D.value={...D.value,[o.codigo]:!1}}}function T(o){if(!o)return"No disponible";try{const t=new Date(o);if(isNaN(t.getTime()))return o;const a=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),u=String(t.getDate()).padStart(2,"0");return`${a}-${e}-${u}`}catch(t){return console.error("Error formateando fecha:",t),o}}return(o,t)=>{var a;return r(),l("div",H,[t[17]||(t[17]=s("h2",{style:{"text-align":"center"}},"HISTORIAL DE PACIENTES ATENDIDOS",-1)),s("div",U,[s("div",M,[s("div",R,[t[2]||(t[2]=s("label",{for:"filtroDesde",class:"filtro-label"},"Desde:",-1)),A(s("input",{id:"filtroDesde","onUpdate:modelValue":t[0]||(t[0]=e=>d.value=e),type:"date",class:"filtro-input"},null,512),[[I,d.value]])]),s("div",B,[t[3]||(t[3]=s("label",{for:"filtroHasta",class:"filtro-label"},"Hasta:",-1)),A(s("input",{id:"filtroHasta","onUpdate:modelValue":t[1]||(t[1]=e=>p.value=e),type:"date",class:"filtro-input"},null,512),[[I,p.value]])]),s("div",V,[s("button",{onClick:S,class:"btn btn-primary btn-buscar",disabled:v.value}," 🔍 Buscar ",8,$),s("button",{onClick:C,class:"btn btn-secondary btn-limpiar",disabled:v.value}," 🧹 Limpiar ",8,G)])])]),v.value?(r(),l("div",X,[...t[4]||(t[4]=[s("p",null,"Cargando historial de pacientes...",-1)])])):n.value?(r(),l("div",Y,[s("p",null,i(n.value),1)])):(r(),l("div",j,[c.value.length===0?(r(),l("div",z,[t[5]||(t[5]=s("p",null,"NO HAY PACIENTES ATENDIDOS EN ESTA FECHA",-1)),s("p",null,"DNI DEL ESTUDIANTE: "+i(((a=k(E).user)==null?void 0:a.CDNIEST)||"NO DISPONIBLE"),1)])):b("",!0),(r(!0),l(x,null,L(c.value,e=>(r(),l("div",{key:e.codigo,class:"historial-card"},[s("div",q,[t[6]||(t[6]=s("strong",null,"PACIENTE:",-1)),t[7]||(t[7]=g()),s("span",null,i(e.paciente),1)]),s("div",J,[t[8]||(t[8]=s("strong",null,"DNI:",-1)),t[9]||(t[9]=g()),s("span",null,i(e.dni),1)]),s("div",K,[t[10]||(t[10]=s("strong",null,"NÚMERO DE PAGO:",-1)),t[11]||(t[11]=g()),s("span",null,i(e.codigo),1)]),s("div",Q,[t[12]||(t[12]=s("strong",null,"MONTO:",-1)),t[13]||(t[13]=g()),s("span",null,"S/ "+i(e.monto.toFixed(2)),1)]),s("div",W,[t[14]||(t[14]=s("strong",null,"ESTADO:",-1)),s("div",Z,[s("span",{class:P(["estado-icon",N(e.estado).class])},i(N(e.estado).icon),3),s("span",tt,i(N(e.estado).texto),1),e.estado==="F"?(r(),l("button",{key:0,class:"btn-descargar",onClick:u=>O(e),title:"Descargar detalles del pago facturado"},[D.value[e.codigo]?(r(),l("span",et,"⏳")):(r(),l("span",ot,"💾"))],8,st)):b("",!0)])]),s("div",at,[t[15]||(t[15]=s("strong",null,"FECHA:",-1)),t[16]||(t[16]=g()),s("span",null,i(T(e.fecha)),1)])]))),128))]))])}}},dt=h(nt,[["__scopeId","data-v-70155821"]]);export{dt as default};
