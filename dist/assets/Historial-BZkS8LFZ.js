import{_ as T,u as w,r as D,l as F,c as r,a as t,w as I,v as b,t as d,b as _,h as P,F as k,A as x,o as i,s as N,p as H}from"./index-ETxFn6l9.js";import{h as C,o as L}from"./pagoService-CNgpmn24.js";const U={class:"card"},R={class:"filtros-container"},$={class:"filtros-row"},B={class:"filtro-item"},M={class:"filtro-item"},V={class:"filtro-buttons"},G=["disabled"],z=["disabled"],X={key:0,class:"cargando"},Y={key:1,class:"error-message"},j={key:2,class:"historial-container"},q={key:0,class:"no-pacientes"},J={class:"historial-row"},K={class:"historial-row"},Q={class:"historial-row"},W={class:"historial-row"},Z={class:"historial-row"},ee={class:"estado-container"},te={class:"estado-texto"},se=["onClick"],oe={key:0},ae={key:1},ne={class:"historial-row"},le={__name:"Historial",setup(re){const g=w(),c=D([]),v=D(!1),n=D(""),E=D({}),u=D(""),p=D("");F(async()=>{const e=new Date().toISOString().split("T")[0];u.value=e,p.value=e,await y()});async function y(){var o,e;try{v.value=!0,n.value="";const a=(o=g.user)==null?void 0:o.CDNIEST;if(!a){n.value="No se encontró el DNI del estudiante";return}console.log("Usuario autenticado completo:",g.user),console.log("CDNIEST (DNI del estudiante):",(e=g.user)==null?void 0:e.CDNIEST),console.log("DNI del estudiante para historial:",a);const s=u.value,l=p.value||u.value;if(s&&l&&new Date(s)>new Date(l)){n.value="La fecha de inicio no puede ser posterior a la fecha final.";return}const f=await C(a,s,l);c.value=f,console.log("Pacientes atendidos encontrados:",c.value)}catch(a){n.value="FALLÓ LA CONEXIÓN",console.error("Error:",a)}finally{v.value=!1}}async function S(){var o;try{v.value=!0,n.value="";const e=(o=g.user)==null?void 0:o.CDNIEST;if(!e){n.value="No se encontró el DNI del estudiante";return}const a=u.value,s=p.value||u.value;if(a&&s&&new Date(a)>new Date(s)){n.value="LA FECHA DE INICIO NO PUEDE SER POSTERIOR A LA FECHA FINAL.";return}const l=await C(e,a,s);c.value=l,console.log("Total de pacientes encontrados:",c.value.length)}catch(e){n.value=e.message||"Error al cargar el historial de pacientes",console.error("Error:",e)}finally{v.value=!1}}async function h(){u.value="",p.value="",c.value=[]}function m(o){switch(o){case"C":return{icon:"✔️",class:"estado-pagado",texto:"PAGADO"};case"A":return{icon:"⏳",class:"estado-pendiente",texto:"PENDIENTE DE PAGO"};case"X":return{icon:"❌",class:"estado-anulado",texto:"ANULADO"};case"F":return{icon:"📄",class:"estado-facturado",texto:"FACTURADO"};default:return{icon:"❔",class:"estado-desconocido",texto:"DESCONOCIDO"}}}async function O(o){try{E.value={...E.value,[o.codigo]:!0},n.value="";const e=await L(o.cboleta),a=A(o.fecha),l=`${String(o.paciente||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"_").replace(/[^\w]/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"")}_FACTURADA_${a}.pdf`,f=document.createElement("a");f.href=encodeURIComponent(e),f.download=l,document.body.appendChild(f),f.click(),document.body.removeChild(f)}catch(e){console.error("Descarga fallida:",e),n.value="No se pudo descargar la boleta. Intenta nuevamente."}finally{E.value={...E.value,[o.codigo]:!1}}}function A(o){if(!o)return"No disponible";try{const e=new Date(o);if(isNaN(e.getTime()))return o;const a=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0");return`${a}-${s}-${l}`}catch(e){return console.error("Error formateando fecha:",e),o}}return(o,e)=>{var a;return i(),r("div",U,[e[17]||(e[17]=t("h2",{style:{"text-align":"center"}},"HISTORIAL DE PACIENTES ATENDIDOS",-1)),t("div",R,[t("div",$,[t("div",B,[e[2]||(e[2]=t("label",{for:"filtroDesde",class:"filtro-label"},"Desde:",-1)),I(t("input",{id:"filtroDesde","onUpdate:modelValue":e[0]||(e[0]=s=>u.value=s),type:"date",class:"filtro-input"},null,512),[[b,u.value]])]),t("div",M,[e[3]||(e[3]=t("label",{for:"filtroHasta",class:"filtro-label"},"Hasta:",-1)),I(t("input",{id:"filtroHasta","onUpdate:modelValue":e[1]||(e[1]=s=>p.value=s),type:"date",class:"filtro-input"},null,512),[[b,p.value]])]),t("div",V,[t("button",{onClick:S,class:"btn btn-primary btn-buscar",disabled:v.value}," 🔍 Buscar ",8,G),t("button",{onClick:h,class:"btn btn-secondary btn-limpiar",disabled:v.value}," 🧹 Limpiar ",8,z)])])]),v.value?(i(),r("div",X,[...e[4]||(e[4]=[t("p",null,"Cargando historial de pacientes...",-1)])])):n.value?(i(),r("div",Y,[t("p",null,d(n.value),1)])):(i(),r("div",j,[c.value.length===0?(i(),r("div",q,[e[5]||(e[5]=t("p",null,"NO HAY PACIENTES ATENDIDOS EN ESTA FECHA",-1)),t("p",null,"DNI DEL ESTUDIANTE: "+d(((a=P(g).user)==null?void 0:a.CDNIEST)||"NO DISPONIBLE"),1)])):_("",!0),(i(!0),r(k,null,x(c.value,s=>(i(),r("div",{key:s.codigo,class:"historial-card"},[t("div",J,[e[6]||(e[6]=t("strong",null,"PACIENTE:",-1)),e[7]||(e[7]=N()),t("span",null,d(s.paciente),1)]),t("div",K,[e[8]||(e[8]=t("strong",null,"DNI:",-1)),e[9]||(e[9]=N()),t("span",null,d(s.dni),1)]),t("div",Q,[e[10]||(e[10]=t("strong",null,"NÚMERO DE PAGO:",-1)),e[11]||(e[11]=N()),t("span",null,d(s.codigo),1)]),t("div",W,[e[12]||(e[12]=t("strong",null,"MONTO:",-1)),e[13]||(e[13]=N()),t("span",null,"S/ "+d(s.monto.toFixed(2)),1)]),t("div",Z,[e[14]||(e[14]=t("strong",null,"ESTADO:",-1)),t("div",ee,[t("span",{class:H(["estado-icon",m(s.estado).class])},d(m(s.estado).icon),3),t("span",te,d(m(s.estado).texto),1),s.estado==="F"?(i(),r("button",{key:0,class:"btn-descargar",onClick:l=>O(s),title:"Descargar detalles del pago facturado"},[E.value[s.codigo]?(i(),r("span",oe,"⏳")):(i(),r("span",ae,"💾"))],8,se)):_("",!0)])]),t("div",ne,[e[15]||(e[15]=t("strong",null,"FECHA:",-1)),e[16]||(e[16]=N()),t("span",null,d(A(s.fecha)),1)])]))),128))]))])}}},ue=T(le,[["__scopeId","data-v-63d4613d"]]);export{ue as default};
