import{_,u as w,r as p,l as F,c as l,a as e,w as A,v as I,t as i,b as m,h as k,F as x,A as L,o as r,s as g,p as P}from"./index-Xaxzg0Se.js";import{h as y}from"./pagoService-DPhzBUMq.js";const H={class:"card"},U={class:"filtros-container"},M={class:"filtros-row"},R={class:"filtro-item"},B={class:"filtro-item"},V={class:"filtro-buttons"},$=["disabled"],G=["disabled"],X={key:0,class:"cargando"},Y={key:1,class:"error-message"},j={key:2,class:"historial-container"},z={key:0,class:"no-pacientes"},q={class:"historial-row"},J={class:"historial-row"},K={class:"historial-row"},Q={class:"historial-row"},W={class:"historial-row"},Z={class:"estado-container"},tt={class:"estado-texto"},et=["onClick"],st={key:0},ot={key:1},at={class:"historial-row"},nt={__name:"Historial",setup(lt){const D=w(),c=p([]),v=p(!1),n=p(""),E=p({}),d=p(""),f=p("");F(async()=>{const t=new Date().toISOString().split("T")[0];d.value=t,f.value=t,await b()});async function b(){var a,t;try{v.value=!0,n.value="";const o=(a=D.user)==null?void 0:a.CDNIEST;if(!o){n.value="No se encontró el DNI del estudiante";return}console.log("Usuario autenticado completo:",D.user),console.log("CDNIEST (DNI del estudiante):",(t=D.user)==null?void 0:t.CDNIEST),console.log("DNI del estudiante para historial:",o);const s=d.value,u=f.value||d.value;if(s&&u&&new Date(s)>new Date(u)){n.value="La fecha de inicio no puede ser posterior a la fecha final.";return}const T=await y(o,s,u);c.value=T,console.log("Pacientes atendidos encontrados:",c.value)}catch(o){n.value="FALLÓ LA CONEXIÓN",console.error("Error:",o)}finally{v.value=!1}}async function C(){var a;try{v.value=!0,n.value="";const t=(a=D.user)==null?void 0:a.CDNIEST;if(!t){n.value="No se encontró el DNI del estudiante";return}const o=d.value,s=f.value||d.value;if(o&&s&&new Date(o)>new Date(s)){n.value="LA FECHA DE INICIO NO PUEDE SER POSTERIOR A LA FECHA FINAL.";return}const u=await y(t,o,s);c.value=u,console.log("Total de pacientes encontrados:",c.value.length)}catch(t){n.value=t.message||"Error al cargar el historial de pacientes",console.error("Error:",t)}finally{v.value=!1}}async function S(){d.value="",f.value="",c.value=[]}function N(a){switch(a){case"C":return{icon:"✔️",class:"estado-pagado",texto:"PAGADO"};case"A":return{icon:"⏳",class:"estado-pendiente",texto:"PENDIENTE DE PAGO"};case"X":return{icon:"❌",class:"estado-anulado",texto:"ANULADO"};case"F":return{icon:"📄",class:"estado-facturado",texto:"FACTURADO"};default:return{icon:"❔",class:"estado-desconocido",texto:"DESCONOCIDO"}}}async function h(a){try{E.value={...E.value,[a.codigo]:!0},n.value="";const t=`https://transacciones.ucsm.edu.pe//FILES/TMP/${a.cboleta}`,o=document.createElement("a");o.href=t,o.download="",document.body.appendChild(o),o.click(),document.body.removeChild(o)}catch(t){console.error("Descarga fallida:",t),n.value="No se pudo descargar la boleta. Intenta nuevamente."}finally{E.value={...E.value,[a.codigo]:!1}}}function O(a){if(!a)return"No disponible";try{const t=new Date(a);if(isNaN(t.getTime()))return a;const o=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),u=String(t.getDate()).padStart(2,"0");return`${o}-${s}-${u}`}catch(t){return console.error("Error formateando fecha:",t),a}}return(a,t)=>{var o;return r(),l("div",H,[t[17]||(t[17]=e("h2",{style:{"text-align":"center"}},"HISTORIAL DE PACIENTES ATENDIDOS",-1)),e("div",U,[e("div",M,[e("div",R,[t[2]||(t[2]=e("label",{for:"filtroDesde",class:"filtro-label"},"Desde:",-1)),A(e("input",{id:"filtroDesde","onUpdate:modelValue":t[0]||(t[0]=s=>d.value=s),type:"date",class:"filtro-input"},null,512),[[I,d.value]])]),e("div",B,[t[3]||(t[3]=e("label",{for:"filtroHasta",class:"filtro-label"},"Hasta:",-1)),A(e("input",{id:"filtroHasta","onUpdate:modelValue":t[1]||(t[1]=s=>f.value=s),type:"date",class:"filtro-input"},null,512),[[I,f.value]])]),e("div",V,[e("button",{onClick:C,class:"btn btn-primary btn-buscar",disabled:v.value}," 🔍 Buscar ",8,$),e("button",{onClick:S,class:"btn btn-secondary btn-limpiar",disabled:v.value}," 🧹 Limpiar ",8,G)])])]),v.value?(r(),l("div",X,[...t[4]||(t[4]=[e("p",null,"Cargando historial de pacientes...",-1)])])):n.value?(r(),l("div",Y,[e("p",null,i(n.value),1)])):(r(),l("div",j,[c.value.length===0?(r(),l("div",z,[t[5]||(t[5]=e("p",null,"NO HAY PACIENTES ATENDIDOS EN ESTA FECHA",-1)),e("p",null,"DNI DEL ESTUDIANTE: "+i(((o=k(D).user)==null?void 0:o.CDNIEST)||"NO DISPONIBLE"),1)])):m("",!0),(r(!0),l(x,null,L(c.value,s=>(r(),l("div",{key:s.codigo,class:"historial-card"},[e("div",q,[t[6]||(t[6]=e("strong",null,"PACIENTE:",-1)),t[7]||(t[7]=g()),e("span",null,i(s.paciente),1)]),e("div",J,[t[8]||(t[8]=e("strong",null,"DNI:",-1)),t[9]||(t[9]=g()),e("span",null,i(s.dni),1)]),e("div",K,[t[10]||(t[10]=e("strong",null,"NÚMERO DE PAGO:",-1)),t[11]||(t[11]=g()),e("span",null,i(s.codigo),1)]),e("div",Q,[t[12]||(t[12]=e("strong",null,"MONTO:",-1)),t[13]||(t[13]=g()),e("span",null,"S/ "+i(s.monto.toFixed(2)),1)]),e("div",W,[t[14]||(t[14]=e("strong",null,"ESTADO:",-1)),e("div",Z,[e("span",{class:P(["estado-icon",N(s.estado).class])},i(N(s.estado).icon),3),e("span",tt,i(N(s.estado).texto),1),s.estado==="F"?(r(),l("button",{key:0,class:"btn-descargar",onClick:u=>h(s),title:"Descargar detalles del pago facturado"},[E.value[s.codigo]?(r(),l("span",st,"⏳")):(r(),l("span",ot,"💾"))],8,et)):m("",!0)])]),e("div",at,[t[15]||(t[15]=e("strong",null,"FECHA:",-1)),t[16]||(t[16]=g()),e("span",null,i(O(s.fecha)),1)])]))),128))]))])}}},dt=_(nt,[["__scopeId","data-v-dfa7ddd1"]]);export{dt as default};
