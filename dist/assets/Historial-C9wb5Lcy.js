import{_ as P,u as F,r as E,C as x,c,a as e,w as A,v as m,t as i,b as I,f as k,F as H,z as R,o as d,m as h,n as L}from"./index-Cj1LC5wF.js";import{h as S}from"./pagoService-TImjt0rm.js";const U={class:"card"},$={class:"filtros-container"},M={class:"filtros-row"},B={class:"filtro-item"},G={class:"filtro-item"},V={class:"filtro-buttons"},z=["disabled"],Y=["disabled"],j={key:0,class:"cargando"},X={key:1,class:"error-message"},q={key:2,class:"historial-container"},J={key:0,class:"no-pacientes"},K={class:"historial-row"},Q={class:"historial-row"},W={class:"historial-row"},Z={class:"historial-row"},tt={class:"historial-row"},st={class:"estado-container"},et={class:"estado-texto"},ot=["onClick"],at={class:"historial-row"},lt={__name:"Historial",setup(nt){const D=F(),f=E([]),v=E(!1),u=E(""),n=E(""),p=E("");x(async()=>{const o=new Date;n.value=o.toISOString().split("T")[0],await C()});async function C(o=null){var t,a;try{v.value=!0,u.value="";const s=(t=D.user)==null?void 0:t.CDNIEST;if(!s){u.value="No se encontró el DNI del estudiante";return}console.log("Usuario autenticado completo:",D.user),console.log("CDNIEST (DNI del estudiante):",(a=D.user)==null?void 0:a.CDNIEST),console.log("DNI del estudiante para historial:",s);let l=null;o?l=o:n.value&&p.value||n.value?l=n.value:l=new Date().toISOString().split("T")[0],console.log("Fecha para API:",l);const r=await S(s,l);f.value=r,console.log("Pacientes atendidos encontrados:",f.value)}catch(s){u.value=s.message||"Error al cargar el historial de pacientes",console.error("Error:",s)}finally{v.value=!1}}async function T(){var o;try{v.value=!0,u.value="";const t=(o=D.user)==null?void 0:o.CDNIEST;if(!t){u.value="No se encontró el DNI del estudiante";return}let a=[];n.value&&p.value?a=b(n.value,p.value):n.value?a=[n.value]:a=[new Date().toISOString().split("T")[0]],console.log("Fechas a consultar:",a);const s=[];for(const r of a)try{console.log(`Consultando fecha: ${r}`);const g=await S(t,r);g&&g.length>0&&s.push(...g)}catch(g){console.warn(`Error consultando fecha ${r}:`,g)}const l=w(s);f.value=l,console.log("Total de pacientes encontrados:",f.value.length)}catch(t){u.value=t.message||"Error al cargar el historial de pacientes",console.error("Error:",t)}finally{v.value=!1}}function b(o,t){const a=[],s=new Date(o),l=new Date(t);s>l&&([s,l]=[l,s]);const r=new Date(s);for(;r<=l;)a.push(r.toISOString().split("T")[0]),r.setDate(r.getDate()+1);return a}function w(o){const t=new Map;return o.forEach(a=>{const s=a.codigo||a.CNROPAG;s&&!t.has(s)&&t.set(s,a)}),Array.from(t.values())}async function O(){n.value="",p.value="",f.value=[]}function N(o){switch(o){case"C":return{icon:"✔️",class:"estado-pagado",texto:"PAGADO"};case"A":return{icon:"⏳",class:"estado-pendiente",texto:"PENDIENTE DE PAGO"};case"X":return{icon:"❌",class:"estado-anulado",texto:"ANULADO"};case"F":return{icon:"📄",class:"estado-facturado",texto:"FACTURADO"};default:return{icon:"❔",class:"estado-desconocido",texto:"DESCONOCIDO"}}}function y(o){const t=`https://transacciones.ucsm.edu.pe/descargas/${o}.pdf`;window.open(t,"_blank")}function _(o){if(!o)return"No disponible";try{const t=new Date(o);if(isNaN(t.getTime()))return o;const a=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0");return`${a}-${s}-${l}`}catch(t){return console.error("Error formateando fecha:",t),o}}return(o,t)=>{var a;return d(),c("div",U,[t[17]||(t[17]=e("h2",{style:{"text-align":"center"}},"HISTORIAL DE PACIENTES ATENDIDOS",-1)),e("div",$,[e("div",M,[e("div",B,[t[2]||(t[2]=e("label",{for:"filtroDesde",class:"filtro-label"},"Desde:",-1)),A(e("input",{id:"filtroDesde","onUpdate:modelValue":t[0]||(t[0]=s=>n.value=s),type:"date",class:"filtro-input"},null,512),[[m,n.value]])]),e("div",G,[t[3]||(t[3]=e("label",{for:"filtroHasta",class:"filtro-label"},"Hasta:",-1)),A(e("input",{id:"filtroHasta","onUpdate:modelValue":t[1]||(t[1]=s=>p.value=s),type:"date",class:"filtro-input"},null,512),[[m,p.value]])]),e("div",V,[e("button",{onClick:T,class:"btn btn-primary btn-buscar",disabled:v.value}," 🔍 Buscar ",8,z),e("button",{onClick:O,class:"btn btn-secondary btn-limpiar",disabled:v.value}," 🧹 Limpiar ",8,Y)])])]),v.value?(d(),c("div",j,[...t[4]||(t[4]=[e("p",null,"Cargando historial de pacientes...",-1)])])):u.value?(d(),c("div",X,[e("p",null,i(u.value),1)])):(d(),c("div",q,[f.value.length===0?(d(),c("div",J,[t[5]||(t[5]=e("p",null,"NO HAY PACIENTES ATENDIDOS EN ESTA FECHA",-1)),e("p",null,"DNI DEL ESTUDIANTE: "+i(((a=k(D).user)==null?void 0:a.CDNIEST)||"NO DISPONIBLE"),1)])):I("",!0),(d(!0),c(H,null,R(f.value,s=>(d(),c("div",{key:s.codigo,class:"historial-card"},[e("div",K,[t[6]||(t[6]=e("strong",null,"PACIENTE:",-1)),t[7]||(t[7]=h()),e("span",null,i(s.paciente),1)]),e("div",Q,[t[8]||(t[8]=e("strong",null,"DNI:",-1)),t[9]||(t[9]=h()),e("span",null,i(s.dni),1)]),e("div",W,[t[10]||(t[10]=e("strong",null,"NÚMERO DE PAGO:",-1)),t[11]||(t[11]=h()),e("span",null,i(s.codigo),1)]),e("div",Z,[t[12]||(t[12]=e("strong",null,"MONTO:",-1)),t[13]||(t[13]=h()),e("span",null,"S/ "+i(s.monto.toFixed(2)),1)]),e("div",tt,[t[14]||(t[14]=e("strong",null,"ESTADO:",-1)),e("div",st,[e("span",{class:L(["estado-icon",N(s.estado).class])},i(N(s.estado).icon),3),e("span",et,i(N(s.estado).texto),1),s.estado==="F"?(d(),c("button",{key:0,class:"btn-descargar",onClick:l=>y(s.codigo),title:"Descargar detalles del pago facturado"}," 📥 DESCARGAR ",8,ot)):I("",!0)])]),e("div",at,[t[15]||(t[15]=e("strong",null,"FECHA:",-1)),t[16]||(t[16]=h()),e("span",null,i(_(s.fecha)),1)])]))),128))]))])}}},ut=P(lt,[["__scopeId","data-v-dedefee5"]]);export{ut as default};
